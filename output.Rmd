---
title: "Global Ecological Footprint in 2016"
subtitle: 'Final exam in the course Managing Big and Spatial Data in Social Science'
author:
- Louise Dagmar Madsen^[louise.d.madsen@gmail.com]
- Gergo Literati^[gerliterati@gmail.com ]
- Dominik Zdyb Lillemaehlum^[dominik2711@gmail.com]
date: "August 25, 2017"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    fig_width: 14
    fig_height: 14
---

# Read data

```{r Read data, echo=FALSE, message=FALSE, warning=FALSE}
path_to_data <- "/home/dominik/Dropbox/Kandidat/Managing_big/footprint"
# path_to_data <- "/Users/louisedagmarmadsen/Dropbox/Uni-noter/Kandidat/Sommerskole 2017/Managing and Analysing Cross Sectional and Spatial Data in Social Science/Exam"
# path_to_data <- "e:/001gerliterati/Let?lt?sek/Summer course/project/footprint"
# You can provide a relative path with knitr::opts_chunk$set(root.dir = normalizePath(".."))
knitr::opts_knit$set(root.dir = path_to_data)
knitr::opts_knit$get("root.dir") # prints the working directory

countries <- read.csv(file = "countries.csv")
```

# Data inspection and cleaning

```{r Data inspection and cleaning, echo=TRUE, message=FALSE, warning=FALSE}
dim(countries) # rows and columns
str(countries) # variable and their mode.

# Change modes and remove a $ sign
countries$Country <- as.character(countries$Country) # Change Country from factor to numeric
countries$GDP.per.Capita <- as.character(countries$GDP.per.Capita)
countries$GDP.per.Capita <- gsub(x = countries$GDP.per.Capita, pattern = "$", replacement = "", fixed = T) # fixed = T makes gsub understand pattern as a string insted of regex
countries$GDP.per.Capita <- gsub(x = countries$GDP.per.Capita, pattern = ",", replacement = "", fixed = T)
countries$GDP.per.Capita <- as.numeric(countries$GDP.per.Capita)

# Changing regions: Eastern/EFTA Europe

# Character version of Region
countries$Region1 <- as.character(countries$Region)

countries$Region1[countries$Region1 == "Northern/Eastern Europe"] <- "Eastern Europe"
countries$Region1[countries$Region1 == "European Union"] <- "European Union/EFTA"
countries$Region1[countries$Country == "Norway"] <- "European Union/EFTA"
countries$Region1[countries$Country == "Switzerland"] <- "European Union/EFTA"

# Look for NA's ##
colSums(sapply(countries, is.na)) # Number of NA's per variable
countries[rowSums(is.na(countries)) > 0,c(1,3)] # Return countries with NA's and their population.
# Few big countries lack data (Cambodia, CÃ´te d'Ivoire, Finland, Korea, Norway, Somalia, Syrian Arab Republic) )
# When running different functions consider using na.rm = T.

# Look for outliers ##
# install.packages("GGally")
library(GGally)
ggpairs(countries[,3:11])  # showing scatterplots

```

# Global distribution of the ecological footprint.

```{r Global distribution of the ecological footprint, echo=TRUE, message=FALSE, warning=FALSE, results='asis'}
library(ggplot2)
# summing up the population of the 188 countries represented in the data
Total.Global.Population<-sum(countries$Population..millions.)


# adding a vector to data frame showing country level total footprint
# as ecological footprint per capita multiplied the population of the country
countries$Country.Level.Total.Footprint<-countries$Population..millions.*countries$Total.Ecological.Footprint

# determining total global footprint as the sum of country level total footprints
Total.Global.Footprint<-sum(countries$Country.Level.Total.Footprint)


# determining global average footprint per capita as total global footprint divided by population
Average.Total.Ecological.Footprint<-Total.Global.Footprint/Total.Global.Population


# adding a vector to data frame showing country level biocapacity
# as biocapacity per capita multiplied the population of the country
countries$Country.Level.Total.Biocapacity<-countries$Population..millions.*countries$Total.Biocapacity

# determining total global biocapacity as the sum of country level biocapacities
Total.Global.Biocapacity<-sum(countries$Country.Level.Total.Biocapacity)

# determining global average biocapacity per capita as total global biocapacity divided by population
Average.Total.Biocapacity<-Total.Global.Biocapacity/Total.Global.Population


# determining rate of overshoot as total global footprint divided by total global biocapacity
Rate.of.overshoot<-Total.Global.Footprint/Total.Global.Biocapacity


Global.overshooting.day<-1/Rate.of.overshoot*365


# Present results in a stargazer table.

key_titles <- c("Total Global Population",
                "Total Global Footprint",
                "Average Total Ecological Footprint",
                "Total Global Biocapacity",
                "Average Total Biocapacity",
                "Rate of overshoot",
                "Global overshooting day")

key_numbers <- c(Total.Global.Population,
                 Total.Global.Footprint,
                 Average.Total.Ecological.Footprint,
                 Total.Global.Biocapacity,
                 Average.Total.Biocapacity,
                 Rate.of.overshoot,
                 Global.overshooting.day)

key_numbers_table <- data.frame(key_titles, key_numbers)

knitr::kable(key_numbers_table, digits = 0, col.names = c("Name of the key number", "Key number"))
```

## What is the distribution of TEFP compared to global average footprint and biocapacity?

```{r What is the distribution of TEFP compared to global average footprint and biocapacity, echo=TRUE, message=FALSE, warning=FALSE}
#making a histogram for footprint
#adding a vertical line showing global per capita biocap would be nice
ggplot(data=countries, aes(x=Total.Ecological.Footprint))+
  geom_histogram( fill = "#E69F00", color = "dodgerblue2") + #colour of the bins' body and the lining
  labs(x="Total Ecological Footprint per Capita", y = "Number of countries") + #labelling x and y axis
  stat_bin(aes(y=..count.., label=ifelse(..count.. > 0, ..count.., "")), geom="text", vjust=-0.5)+ # labelling bins wrt frequency on y axis hiding zeros
  ggtitle("Total Ecological Footprint per Capita in the different countries") + # adding title
  theme(plot.title = element_text(lineheight=.8, face="bold"))+ # setting title format
  geom_vline(xintercept = Average.Total.Ecological.Footprint, linetype="dotdash")+ #adding a vertical line showing global average per capita footprint
  geom_text(mapping=aes(x=Average.Total.Ecological.Footprint,y=0, label="Global Average Ecological Footprint per Capita = 2.80"),
            size=3, angle=90, vjust=-0.4, hjust=0, color="#CC0000")+ #labelling vertical line, setting its font size, direction, position
  geom_vline(xintercept = Average.Total.Biocapacity, linetype="dotdash")+ #adding a vertical dotdash line showing global average biocapacity per capita
  geom_text(mapping=aes(x=Average.Total.Biocapacity,y=0, label="Global Average Biocapacity per Capita = 1.78"),
            size=3, angle=90, vjust=-0.4, hjust=0, color="#009E73") #labelling vertical dotdash line, setting its font size, direction, position

```

## Do countries with similar TEFP per capita have the same effect on the global level overshooting?

```{r Do countries with similar TEFP per capita have the same effect on the global level of overshooting, echo=TRUE, message=FALSE, warning=FALSE}
#making a log scale histogram for the distribution of countries wrt their population

ggplot(data=countries, aes(x=Population..millions.))+ #determining the data set and variable used in ggplot2 functions below
  geom_histogram( fill = "#56B4E9", color = "dodgerblue2") + #colour of the bins' body and lining
  scale_x_continuous(trans="log10",breaks = c(1,5,10,50,100,500,1000,1500)) + # setting x axis to log scale and breaks as a numeric vector
  labs(x="Population (Millions) - Log scale ", y = "Number of countries") + #labelling x and y axis
  stat_bin(aes(y=..count.., label=..count..), geom="text", vjust=-0.5)+ # labelling bins wrt frequency on y axis
  ggtitle("Countries by population") + # adding title
  theme(plot.title = element_text(lineheight=.8, face="bold")) # setting title format


# countries with high population weigh more in global level overshooting

# plotting cumulative distribution of global population with respect to TEFP per Capita
# the two vertical lines show the proportion of global population having a footprint of a sustainable level and an average level respectively
ggplot(data=countries[order(countries$Total.Ecological.Footprint) , ], # ordering dataframe by TEFP so that we can sum population in order of TEFP
       aes(x =  Total.Ecological.Footprint, y =  cumsum(Population..millions.)))+ #determining variables used in ggplot2 functions below
  geom_point(aes(colour=Region1, size=GDP.per.Capita))+ #adding data points to countries with different colours in different regions
  labs(x="Total Ecological Footprint per Capita", y = "Cummulative population of countries") + #labelling x and y axis
  ggtitle("Cumulative distribution of global population with respect to Total Ecological Footprint per Capita") +  # adding title
  theme(plot.title = element_text(lineheight=.8, face="bold"))+# setting title format
  geom_text(aes(label=ifelse(Population..millions.>150,as.character(Country),'')), hjust=1.17,vjust=0, size=2.5)+#tagging countries with highest population
  geom_vline(xintercept = Average.Total.Ecological.Footprint, linetype="dotdash")+ #adding a vertical line showing global average per capita footprint
  geom_text(mapping=aes(x=Average.Total.Ecological.Footprint,y=0, label="Global Average Ecological Footprint per Capita = 2.80"),
            size=2.5, angle=90, vjust=2, hjust=0.1, color="#CC0000")+ #labelling vertical line, setting its font size, direction, position
  geom_vline(xintercept = Average.Total.Biocapacity, linetype="dotdash")+ #adding a vertical line showing global average biocapacity per capita
  geom_text(mapping=aes(x=Average.Total.Biocapacity,y=0, label="Global Average Biocapacity per Capita = 1.78"),
            size=2.5, angle=90, vjust=2, hjust=0.11, color="#009E73")+ #labelling vertical line, setting its font size, direction, position
  scale_size(breaks=c(0,1200,4000,12000,40000))



```

## What drives TEFP per capita?

```{r What drives TEFP per capita, echo=TRUE, message=FALSE, warning=FALSE}
#plotting the relationship of TEFP and CFP


# ggplot(data=countries,aes(x =  Total.Ecological.Footprint, y =  Carbon.Footprint))+ #determining the data set and variable used in ggplot2 functions below
#   geom_point(aes(colour=Region))+ #adding data points to countries with different colours in different regions
#   labs(x="Total Ecological Footprint per Capita", y = "Carbon Footprint per Capita") + #labelling x and y axis
#   ggtitle("The relationship of Total Ecological Footprint per Capita and Carbon Footprint per Capita") + # adding title
#   theme(plot.title = element_text(lineheight=.8, face="bold"))+# setting title format
#   geom_text(aes(label=ifelse(Carbon.Footprint>5 | (Total.Ecological.Footprint>5 & (Carbon.Footprint/Total.Ecological.Footprint<0.6)),as.character(Country),'')),
#             hjust=-0.3,vjust=0, size=2.5)+ #tagging countries with highest carbon footprint or high TEFP with relatively low carbon FP
#   geom_smooth(method='lm',formula=y~x)+ #adding a linear regression line
# 
# #plotting the relationship of TEFP and fish FP
# ggplot(data=countries,aes(x =  Total.Ecological.Footprint, y =  Fish.Footprint))+
#   geom_point(aes(colour=Region))+ ylim(0, 15)

# Maps
#install.packages("rworldmap")
library(rworldmap)

#making a worldmap showing TEFP

globalmap<-joinCountryData2Map(countries,
                            joinCode="NAME", # format of joining country data
                            nameJoinColumn="Country", # column used for joining dataframe to spatial data
                            verbose=T) # if true we get messages to the console while joining country specific data to map

par(mai=c(0,0,0.2,0),xaxs="i",yaxs="i") # graphical parameters on margins and axis

global_tefp<-mapCountryData(mapToPlot=globalmap, nameColumnToPlot="Total.Ecological.Footprint",
                            catMethod=c(0,2,4,6,10), # setting breaks
                            colourPalette="heat",
                            mapRegion="world",
                            addLegend=F,
                            mapTitle="Total Ecological Footprint in the world",
                            aspect=1,lwd=0.5) #map aspect and country borders

#making a worldmap showing CFP

global_cfp<-mapCountryData(mapToPlot=globalmap, nameColumnToPlot="Carbon.Footprint",
                           catMethod=c(0,1,2,3,4,10),
                           colourPalette="heat",
                           mapRegion="world",
                           addLegend=F,
                           mapTitle="Carbon Footprint in the world",
                           aspect=1,lwd=0.5)

```

# Relationship between income and ecological footprint

```{r Relationship between income and ecological footprint, echo=TRUE, message=FALSE, warning=FALSE}

# Income scatterplots

# Total Ecological Footprint ~ Income, colour coded by regions
ggplot(countries, aes(x = GDP.per.Capita, y = Total.Ecological.Footprint, colour = Region1)) + geom_point() +
  labs(title = "Relationship between GDP per Capita and Total Ecological Footprint",
       x ="GDP per Capita ($)", y = "Total Ecological Footprint (gha)", colour = "Region")

# The plot shows a clustering of the majority of countries within the first 'square' of an Total Ecological Footprint
# below 5 gha and GDP pr. Capita below $1500. Outside of this is most European Union/Efta countries and North America
# as well as some Middle East/Central Asian countries (most likely oil producing) and Asia-Pacific.

ggplot(countries, aes(x = GDP.per.Capita, y = Biocapacity.Deficit.or.Reserve, colour = Region1)) + geom_point() +
  labs(title = "Relationship between GDP per Capita and the Biocapacity balance",
       x ="GDP per Capita ($)", y = "Biocapacity - Deficit or Reserve (gha)", colour = "Region")

# This plot looks into the relationship between income and biocapacity balance. Is it the case that income rich
# countries have a biocapacity deficit whilst income poor countries have surplusses? This plot does not suggest
# such a relationship.

# Test of independence between ecological balance and GDP.
reserve <- ifelse(test = countries$Biocapacity.Deficit.or.Reserve > 0, yes = 1, no = 0)
rich <- ifelse(test = countries$GDP.per.Capita > 8280, yes = 1, no = 0)
ind_table <- table(reserve, rich)
chisq.test(ind_table )
# Since we get a p-Value just above the significance level of 0.05,
# we can not reject the null hypothesis that the two variables are dependent. At least not on a 5% level
# We could reject the dependence hypothesis on a 10% level. 

# HDI scatterplots


# We are also looking at the relationship between HDI and ecological footprint.
# As income (GDP pr. capita) is part of HDI, they are highly correlated. Still insteresting to see, if there's
# any difference.

cor(countries$GDP.per.Capita, countries$HDI, use = "complete.obs", method="kendall")
# As expected correlation is high: 0.8075072

# Total Ecological Footprint ~ HDI, colour coded by regions
ggplot(countries, aes(x = HDI, y = Total.Ecological.Footprint, colour = Region1)) + geom_point() +
  labs(title = "Relationship between Human Development Index and Total Ecological Footprint",
       x ="HDI", y = "Total Ecological Footprint (gha)", colour = "Region")

# The plot shows a clear regional clustering in the relationship between HDI and Total Ecological Footprint.
# In the African region there is more variation in the HDI-level, but without increases in the total footprint
# Correspondingly, countries with higher HDI seem to have higher variation in total footprint

# Total Ecological Footprint ~ HDI, different plots for each region
ggplot(countries, aes(x = HDI, y = Total.Ecological.Footprint)) + geom_point() + facet_grid(~Region1)

# A different plot showing the regional differences
```

# What countries have an ecological debt and what countries have surplus?

```{r What countries have an ecological debt and what countries have surplus, echo=TRUE, message=FALSE, warning=FALSE}
library(rworldmap)
library(RColorBrewer) # Add better colors
library(raster)
dfmap <- countries[,c(1,18)]
def_res_map <- joinCountryData2Map(dF = dfmap, joinCode = "NAME", nameJoinColumn = "Country", nameCountryColumn = "Country")
colourPalette <- brewer.pal(7,'RdYlGn')
mapCountryData(def_res_map,
               nameColumnToPlot = "Biocapacity.Deficit.or.Reserve",
               colourPalette=colourPalette)


```















